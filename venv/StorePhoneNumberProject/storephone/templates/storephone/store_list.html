{% extends 'storephone/base.html' %}

{% block content %}

<style>
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    th, td {
        border: 1px solid black;
        padding: 8px;
        text-align: left;
    }

    th {
        background-color: #f2f2f2;
    }

    .call-button, .whatsapp-button, .phone-link {
        display: inline-block;
        padding: 6px 12px;
        text-align: center;
        text-decoration: none;
        border: none; /* Remove border */
        cursor: pointer;
        font-size: 14px;
        background-color: #3498db; /* Set background color */
        color: white; /* Set text color */
        border-radius: 4px; /* Add rounded corners */
        transition: background-color 0.3s ease; /* Add transition effect */
        margin-right: 10px; /* Add margin for spacing */
    }

    .call-button:hover, .whatsapp-button:hover, .phone-link:hover {
        background-color: #2980b9; /* Darker background color on hover */
    }

    .phone-link {
        display: block;
        margin-top: 4px;
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
        table {
            font-size: 12px;
        }

        .call-button, .whatsapp-button, .phone-link {
            padding: 4px 8px;
            font-size: 12px;
        }
    }


   
</style>

<h2>Store List</h2>

<button id="toggleFilterButton">Toggle Filter Options</button>

<div class="sidenav" id="filterSidebar" style="display: none;">
    <form method="GET" id="filterForm">
        <label for="category">Filter by Category:</label>
        <select name="category" id="category">
            <option value="" {% if not selected_category %}selected{% endif %}>All Categories</option>
            {% for category in categories %}
                <option value="{{ category.id }}" {% if category.id == selected_category %}selected{% endif %}>{{ category.name }}</option>
            {% endfor %}
        </select>
    
        <label for="status">Filter by Status:</label>
        <select name="status" id="status">
            <option value="" {% if not selected_status %}selected{% endif %}>All Status</option>
            <option value="clicked" {% if selected_status == "clicked" %}selected{% endif %}>Clicked</option>
            <option value="unclicked" {% if selected_status == "unclicked" %}selected{% endif %}>Unclicked</option>
        </select>
    
        <button type="submit">Apply Filters</button>
    </form>
</div>

<table>
    <tr>
        <th>Name</th>
        <th>Phone Number</th>
        <th>WhatsApp</th>
    </tr>
    {% for store in stores %}
    <tr id="store-row-{{ store.id }}" {% if store.button_clicked %}class="clicked"{% endif %}>
        <td>{{ store.name }}</td>
        <td>
            <a href="tel:{{ store.phone_number }}" class="call-button" data-store-id="{{ store.id }}" onclick="updateAndHideRow(this)">Call {{ store.phone_number }}</a>
        </td>
        <td>
            {% if store.phone_number|length == 10 %}
            <a href="https://wa.me/+91{{ store.phone_number }}" class="whatsapp-button">WhatsApp</a>
            {% elif store.phone_number|length == 12 %}
            <a href="https://wa.me/+{{ store.phone_number }}" class="whatsapp-button">WhatsApp</a>
            {% else %}
            Land line Number
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</table>

<script>
    const toggleButton = document.getElementById('toggleFilterButton');
    const filterSidebar = document.getElementById('filterSidebar');

    toggleButton.addEventListener('click', () => {
        filterSidebar.style.display = filterSidebar.style.display === 'none' ? 'block' : 'none';
        setTimeout(() => {
            filterSidebar.style.display = 'none';
        }, 6000);
    });

    const callButtons = document.querySelectorAll('.call-button');

    callButtons.forEach(button => {
        button.addEventListener('click', function() {
            const storeId = this.getAttribute('data-store-id');
            updateButtonClicked(storeId, this);
        });
    });

    function updateButtonClicked(storeId, button) {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `/update_button_clicked/${storeId}/`, true);

        const csrfToken = getCookie('csrftoken'); // Define the getCookie function
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.setRequestHeader('X-CSRFToken', csrfToken);

        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    button.classList.add('clicked');
                    button.innerText = 'Clicked';
                } else if (xhr.status === 400) {
                    console.error('Button was already clicked.');
                } else {
                    console.error('Error updating button clicked status.');
                }
            }
        };

        xhr.send();
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Function to show or hide elements with the 'clicked' class based on the filter selection
    function applyFilter() {
        const selectedStatus = document.getElementById('status').value;
        const clickedElements = document.querySelectorAll('.clicked');

        if (selectedStatus === 'clicked') {
            clickedElements.forEach(element => {
                element.style.display = 'table-row'; // Display clicked elements
            });
        } else {
            clickedElements.forEach(element => {
                element.style.display = 'none'; // Hide clicked elements
            });
        }
    }

    // Add an event listener to the filter select element
    document.getElementById('status').addEventListener('change', applyFilter);

</script>

{% endblock %}